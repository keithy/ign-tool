
# 
# The AngelBox v0.0.0
#

### Everything you need to know about IAC
#
# https://rollout.io/blog/infrastructure-as-code/
# https://www.plutora.com/blog/infrastructure-as-code
# https://dzone.com/articles/observability-and-beyond-building-resilient-applic
#
 
variant: fcos
version: 1.0.0 ### ignition.yaml, fcos_spec_version is different to ignition.json spec version

passwd:

  groups:
    - name: eternal
      gid: 777
    - name: mortal # makes mistakes - potentially a sinner
      gid: 776
 
  users:
    - name: core
    
      # Password Hash - for tty console login (password is disabled for remote ssh authentication)
      # Generated by: docker run --rm -it flyprogrammer/mkpasswd --method sha-256 --rounds=4096
      # 
      password_hash: $5$ZFDsFpGnnroP$.wRwjUTJz/M5Ycog5meIYXnhNE.BJJNBi/NIPGN9t0C
      #
      # Public Key - for remote ssh authentication
      #
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat

      #
      # A Super-super user (in the AngelBox context)
      #
    - name: god
      uid: 777
      primary_group: eternal
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILlJ9IT/1iLOoolWmdGnMgg1+YzsQDUXvQ9Pwh2wJe8e keithy@fedora31.VBox
      home_dir: /root
      no_create_home: true
      groups:
        - wheel
        - sudo
        - adm
      shell: /bin/bash
      
      #
      # An admin user for automated agents (in the AngelBox context)
      #      
    - name: angel
      uid: 888
      primary_group: eternal
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILlJ9IT/1iLOoolWmdGnMgg1+YzsQDUXvQ9Pwh2wJe8e keithy@fedora31.VBox
      home_dir: /home/angel
      no_create_home: false
      groups:
        - wheel
        - sudo
        - adm
      shell: /bin/bash

      #
      # A mortal user (for troubleshooting)
      #      
    - name: keith # mere mortal
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILlJ9IT/1iLOoolWmdGnMgg1+YzsQDUXvQ9Pwh2wJe8e keithy@fedora31.VBox
      home_dir: /home/keith
      no_create_home: false
      primary_group: mortal
      groups:
        - wheel
        - sudo
      shell: /bin/bash

      #
      # Healthz Check User
      #      
    - name: goss # health check
      uid: 111
      ssh_authorized_keys:
        - command="sudo goss validate ${SSH_ORIGINAL_COMMAND}" ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
      home_dir: /home/goss
      no_create_home: false
      primary_group: mortal
      groups:
        - sudo
      shell: /bin/bash

      #
      # Healthz Check User
      #      
    - name: goss-homeless # health check
      uid: 1111
      ssh_authorized_keys:
        - command="sudo /usr/local/lib/goss/pkg/usr/local/bin/goss validate ${SSH_ORIGINAL_COMMAND}" ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
      no_create_home: true
      primary_group: mortal
      groups:
        - sudo

      #
      # A pioneer
      #      
    - name: arne # mere mortal
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
      home_dir: /home/arne
      no_create_home: false
      primary_group: mortal
      groups:
        - wheel
        - sudo
      shell: /bin/layer-shell

      #
      # A following pioneer
      #      
    - name: otto # mere mortal
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG7mD9tPBt0F1QViMXdyC5eBlXPg4uTIVanU9a5kCpbT keith@samson.flat
      home_dir: /home/otto
      no_create_home: false
      primary_group: mortal
      groups:
        - sudo
      shell: /usr/local/lib/fcos-tools/layer/shells/layer-shell_fedora_coreos.sh
                 
systemd:
  units:       
      ### The AngelBox - the production server that looks after itself
      #
      #  "Works anywhere you put the box"
      #     * Developers Laptop
      #     * Old/New in house servers
      #     * "On" the Cloud.
      #  "Pull-Model"
      #     * FCOS = Self Updating Operating System
      #     * AngelBox = Self Updating Applications
      #  Parallel Development Model
      #
      #  Prezi: https://prezi.com/view/Kug2dHC7H7Ezr7RADpGp/
      #          
    - name: install-angelbox.service
      enabled: true
      contents: |
        [Unit]
        Description=Install AngelBox
        ConditionFirstBoot=yes
        Wants=network-online.target
        After=network-online.target
        Before=install-overlayed-rpms.service
        [Service]
        Type=oneshot
        ExecStart=/bin/sh -c 'curl -LsS https://gitlab.com/keithy/angelbox/-/archive/wip/angelbox-wip.tar.gz | tar xfz - -C /var/home/angel'
        RemainAfterExit=no
        [Install]
        WantedBy=multi-user.target
        
storage: 
  files:     
#    - path: /etc/sshd_config.d/mortals.conf
#      mode: 0644
#      user:
#        id: 0
#      group:
#        id: 0
#      contents:
#        inline: |
#          # COMPOSITION OF SSHD_CONFIG
#          Match Group mortal
#                  ForceCommand mortals-safety.sh

     
      #
      # The Healthz Check Spec - defined inline in this file!
      #    * Code and tests together in one file - does it get any better than this? 
      #
    - path: /etc/goss/goss.yaml 
      mode: 0644
      user:
        id: 1001
      group:
        id: 1001
      contents:
        inline: | 
          service:
            sshd:
              enabled: true
              running: true
          user:
            core:
              exists: true
              uid: 1000
              gid: 1000
              groups:
              - adm
              - core
              - sudo
              - systemd-journal
              - wheel
              home: /var/home/core
              shell: /bin/bash
            goss:
              exists: true
              uid: 111
              gid: 111
              groups:
              - nhs
              - sudo
              home: /home/goss
            keith:
              exists: true
              uid: 1001
              gid: 776
              groups:
              - mortal
              - sudo
              - wheel
              home: /home/keith
              shell: /bin/bash
          group:
            core:
              exists: true
              gid: 1000
            eternal:
              exists: true
              gid: 777
            nhs:
              exists: true
              gid: 111
            mortal:
              exists: true
              gid: 776
          process:
            sshd:
              running: true
          command:
            "disk_space_alert(>=95%)": ## Rolled My Own 'Low Diskspace' Alarm
              # required attributes
              exit-status: 0
              exec: "df --exclude-type=tmpfs --exclude-type=devtmpfs --local"
              # optional attributes
              stdout: ["!/\\s(100|9[5-9])%/"] # >=95%
              stderr: []
              timeout: 3000 # in milliseconds
              skip: false
